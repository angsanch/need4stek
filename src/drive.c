/*
** EPITECH PROJECT, 2024
** drive.c
** File description:
** %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
** %%#*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++%%%%
** %%#*+************************###########%%%##*************************++%%%%
** %%%*+*******+*****+**+**+****###########***##*********+*******+**+**+*++%%%%
** %%%#+********************##%##%##%##%##%##%##%#%%##*******************++%%%%
** %%#*+*****************#####%########################******************++%%%%
** %%#*+*****************##############################**##**************++%%%%
** %%##+***************#%##%##%##%##%##%##%##%##%#%%##%#%****************++%%%%
** %%#*+*******+*******#######################*******+***********+*****+*++%%%%
** %%#*+*************#########%##%#####%####********+++++****************++%%%%
** %%#*+*************#######################********+++++++**************++%%%%
** %%#*+*******+*****#######################*+******+++++++******+**+**+*++%%%%
** %%#*+***********##%#####%##%##%##%##%##%#********+++++++**************++%%%%
** %%#*+***********###########%#############********+++++++**************++%%%%
** %%#*+***********#########################********+++++++**************++%%%%
** %%##+***********##%##%##%##%##%##%##%##%##%##%#**+++++++**************++%%%%
** %%#*+*******+***########################**+**##***+*++++******+*****+*++%%%%
** %%#*+*************#########%##%#####%#**%##++####***##++**************++%%%%
** %%#*+*************####################**###**####**#**++**************++%%%%
** %%%*+*******+*****####################*+*****####**#**++******+**+**+*++%%%%
** %%%#+*************%#####%##%##%##%##%#*******%#%%**%******************++%%%%
** %%#*+*************#########%##########*****#######*+++****************++%%%%
** %%#*+***************##################*****#######*+++****************++%%%%
** %%##+***************#%##%##%##%##%##%#****%##%#%%##*++****************++%%%%
** %%#*+*******+*******##################*+**+#######************+*****+*++%%%%
** %%#*+***********###########%##%#####%#*******####+++******##+*********++%%%%
** %%#*+********#########################***########**+**###########**++*++%%%%
** %%#*+********#########################*+**#######**+**###########*****++%%%%
** %%#*+******##%#%##%#####%##%##%##%##%#****%##%#%%##+#%%#%##%##%##%###*++%%%%
** %%#*+******################%######################**#############%%###++%%%%
** %%#*+****######################################**++*#########**######%*+%%%%
** %%##+#%%#%###%#%##%##%##%##%##%##%##%##%##%##%#++++*#%%%%##%##%##%##%#++%%%%
** %%#*+##########################################***+*******##%########%++%%%%
** %%#*+######################**#%#####%##########*************#####%###%*+%%%%
** %%#*+######################****#########*******************##########%*+%%%%
** %%#*+#######**********#####****#%%####****+*******+***+******#######*%++%%%%
** %%#*+#%%#%###*********##%##%#*##%%##%#***********************#%##%##%%++%%%%
** %%#*+####**###******++*####%###*******++#************************%####++%%%%
** %%#*+**####**#*******++**#######**##**++###**##++*********************++%%%%
** %%##+#%%#*****#%******+****%##%*#%**%#**#**##%#%%##+******************++%%%%
** %%%#+##**##*+*##*****+**+****###*+##################**********+*****+*++%%%%
** %%#*+####**##******************#******#######**++++*####**************++%%%%
** %%#*+*****************+*************##**#######**+++######************++%%%%
** %%#*+*******+*****+**++*+**+**++*+*********####**+++**********+**+**+*++%%%%
** %%#*+*********************************#%***##%#%%**+******************++%%%%
** %%#*+***************************####**#####**#####**++****************++%%%%
** %%#*+*****************************##****############++++*************+++%%%%
** %%##+******##*****%#************#%##****##%##%#%%##%++++**************++%%%%
** %%#*+##****###**######**+****##*##**+*##############++++++****+*****+*++%%%%
** %%#*+%%##**###########*********###****##############**+++++*#*********++%%%%
** %%#*+########%########################################*****##********#++%%%%
** %%#*+#######**########################################*****##**%%****%++%%%%
** %%#*+#%%#%###%#%##%#####%##%##%##%##%##%##%##%#%%##%#%%#%##%##%%%%##%%++%%%%
** %%%#+#######**********###*********##****##***####***##*********##%###%*+%%%%
** %%#*+#######**####*****##****###**##****##***####***##****#####%%#####++%%%%
** %%##+#%%#%##**######***##*********##****###**####**###*********##%##%#++%%%%
** %%#*+#######**######*+*##*******####+**+###***##***###********+##%%##%++%%%%
** %%#*+#######**######***##****##*####****###********###****#######%###%*+%%%%
** %%#*+#######**#####***###****##***##****#####****#####*********##%%###++%%%%
** %%%*+#######******+***###**+*##+*+##+**+#####****#####+*******+##**##%++%%%%
** %%%#+#%%#%###*******#####****##***##****##%##****##%#%*********##%##%%++%%%%
** %%#*+##%%%%##%%%###########%#############%%#########%%%%%%#%%##%%%#%%%*+%%%%
** %%%#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++%%%%
** %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
*/

#include "../include/stek.h"
#include <math.h>

static void throttle(car_t *c)
{
    c->intended.throttle = 10;
    if (c->lidar.front > 7.5)
        c->intended.throttle = 25;
    if (c->lidar.front > 15)
        c->intended.throttle = 35;
    if (c->lidar.front > 25)
        c->intended.throttle = 60;
    if (c->lidar.front > 40)
        c->intended.throttle = 85;
    if (c->lidar.front > 50)
        c->intended.throttle = 100;
    if ((c->lidar.left < 9 || c->lidar.right < 9)
        && c->intended.throttle > 20)
        c->intended.throttle = 21;
}

static void direction(car_t *c)
{
    c->intended.dir = 80;
    if (c->lidar.front > 7.5)
        c->intended.dir = 30;
    if (c->lidar.front > 15)
        c->intended.dir = 20;
    if (c->lidar.front > 25)
        c->intended.dir = 10;
    if (c->lidar.front > 50)
        c->intended.dir = 3;
    if (c->lidar.front > 70)
        c->intended.dir = 0.5;
    if (c->lidar.bias < 0)
        c->intended.dir *= -1;
    if ((c->lidar.left < 9 || c->lidar.right < 9)
        && c->intended.throttle > 20)
        c->intended.dir *= 1.5;
}

void drive(car_t *c)
{
    run_command(GET_INFO_LIDAR, &c->lidar);
    if (c->lidar.front < 1) {
        dprintf(2, "Stuck. Exiting ...\n");
        run_command(STOP_SIMULATION);
    }
    throttle(c);
    direction(c);
    set_direction(c);
    set_throttle(c);
}
